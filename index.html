<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter Reader</title>
    <link rel="stylesheet" href="assets/main.css">
</head>
<body>

    <nav id="category-nav">
        <button class="category-button active" data-category="all">All Articles</button>
    </nav>

    <nav id="toc" class="chapter-list-grid">
    </nav>

    <div id="chapters">
    </div>

    <script type="module">
        import { initAudioPlayer } from './js/audio/audioPlayer.js';

        // 加载并渲染章节内容
        async function loadChapter() {
            try {
                const res = await fetch('data/chapters/1.json'); // 确保路径正确，可能需要从根目录开始
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const json = await res.json();

                renderChapter(json); // 渲染章节内容

                // 在内容渲染完成后，使 #chapters 容器可见
                const chaptersContainer = document.getElementById('chapters');
                if (chaptersContainer) {
                    chaptersContainer.style.display = 'block'; // 或者 'flex', 'grid' 等，取决于你的 CSS 布局
                }

                initAudioPlayer({
                    audioSrc: json.audio, // 确保这个路径正确，例如 'data/audio/audio1.mp3'
                    srtSrc: json.srt     // 确保这个路径正确，例如 'data/srt/audio1.srt'
                });
            } catch (error) {
                console.error('Failed to load or render chapter:', error);
            }
        }

        function renderChapter(json) {
            const container = document.getElementById('chapters');
            if (!container) {
                console.error('Container #chapters not found!');
                return;
            }
            container.innerHTML = ''; // 清空现有内容

            json.paragraphs.forEach(entry => {
                if (typeof entry === 'string') {
                    if (entry.startsWith('##')) {
                        const h2 = document.createElement('h2');
                        h2.textContent = entry.replace(/^##\s*/, '');
                        container.appendChild(h2);
                    } else {
                        const p = document.createElement('p');
                        p.innerHTML = processWordHints(entry);
                        container.appendChild(p);
                    }
                } else if (typeof entry === 'object' && entry.video) {
                    const iframe = document.createElement('iframe');
                    iframe.src = entry.video.replace('watch?v=', 'embed/');
                    iframe.width = '560';
                    iframe.height = '315';
                    iframe.frameBorder = '0';
                    container.appendChild(iframe);
                }
            });
        }

        function processWordHints(text) {
            // 这个函数依赖于你的 `tooltip.js` 或其他处理逻辑
            // 确保如果有 tooltip 功能，相应的脚本已被加载或逻辑在此处处理
            return text.replace(/\[\[(.+?)\|(.+?)\]\]/g, (_, word, hint) => {
                return `<span class="word" data-hint="${hint}">${word}</span>`;
            });
        }

        // 页面加载完成后调用 loadChapter
        document.addEventListener('DOMContentLoaded', loadChapter);
    </script>

    <div id="react-tooltips" class="tooltip"></div>

    <script type="module" src="js/main.js"></script>
</body>
</html>
