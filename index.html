<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter Reader</title>
    <link rel="stylesheet" href="assets/main.css">
</head>
<body>

    <nav id="category-nav">
        <button class="category-button active" data-category="all">All Articles</button>
        </nav>

    
        <nav id="toc" class="chapter-list-grid">
            </nav>

        <div id="chapters" style="display: none;">
            </div>
 
    <div id="react-tooltips" class="tooltip"></div>
<script type="module">
    import { initAudioPlayer } from './js/audio/audioPlayer.js';

    const chaptersContainer = document.getElementById('chapters');
    const tocContainer = document.getElementById('toc'); // 假设你的章节目录容器ID是 'toc'

    let currentChapterJson = null; // 用于存储当前加载的章节数据

    /**
     * 加载并渲染章节列表（目录）
     */
    async function loadChapterList() {
        try {
            const res = await fetch('data/chapters.json'); // 加载包含所有章节元数据的 JSON 文件
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            const chaptersData = await res.json();

            tocContainer.innerHTML = ''; // 清空现有目录

            chaptersData.chapters.forEach(chapterMeta => {
                const chapterItem = document.createElement('div');
                chapterItem.classList.add('chapter-item'); // 可以添加样式类
                chapterItem.dataset.chapterId = chapterMeta.id; // 存储章节ID
                chapterItem.textContent = chapterMeta.title; // 显示章节标题

                // 点击章节标题加载对应章节内容
                chapterItem.addEventListener('click', () => {
                    loadChapterContent(chapterMeta.file); // 加载该章节的实际内容文件
                });
                tocContainer.appendChild(chapterItem);
            });

            // 默认加载第一个章节（或根据需要选择）
            if (chaptersData.chapters.length > 0) {
                loadChapterContent(chaptersData.chapters[0].file);
            }

        } catch (error) {
            console.error('Failed to load chapter list:', error);
        }
    }

    /**
     * 加载并渲染特定章节的内容
     * @param {string} chapterFilePath - 章节内容文件的路径 (例如: "chapters/1.json")
     */
    async function loadChapterContent(chapterFilePath) {
        try {
            // 注意：这里的 chapterFilePath 应该是相对于 index.html 的路径
            // 如果 chapterFilePath 是 "chapters/1.json" 但实际在 "data/chapters/1.json"，需要调整
            const fullPath = `data/${chapterFilePath}`; // 假设你的章节内容都在 data 目录下

            const res = await fetch(fullPath);
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            currentChapterJson = await res.json(); // 保存当前章节数据

            renderChapter(currentChapterJson); // 渲染章节内容

            // 使 #chapters 容器可见
            if (chaptersContainer) {
                chaptersContainer.style.display = 'block'; // 或者 'flex', 'grid' 等
            }

            // 初始化或更新音频播放器
            // 确保 audioSrc 和 srtSrc 是相对于 index.html 的正确路径
            initAudioPlayer({
                audioSrc: `data/${currentChapterJson.audio}`, // 示例：如果 JSON 中是 "chapters/audio/chap-01.mp3"
                srtSrc: `data/${currentChapterJson.srt}`     // 示例：如果 JSON 中是 "chapters/srt/chap-01.srt"
            });

        } catch (error) {
            console.error('Failed to load or render chapter content:', error);
        }
    }

    function renderChapter(json) {
        if (!chaptersContainer) {
            console.error('Container #chapters not found!');
            return;
        }
        chaptersContainer.innerHTML = ''; // 清空现有内容

        json.paragraphs.forEach(entry => {
            if (typeof entry === 'string') {
                if (entry.startsWith('##')) {
                    const h2 = document.createElement('h2');
                    h2.textContent = entry.replace(/^##\s*/, '');
                    chaptersContainer.appendChild(h2);
                } else {
                    const p = document.createElement('p');
                    p.innerHTML = processWordHints(entry);
                    chaptersContainer.appendChild(p);
                }
            } else if (typeof entry === 'object' && entry.video) {
                const iframe = document.createElement('iframe');
                iframe.src = entry.video.replace('watch?v=', 'embed/');
                iframe.width = '560';
                iframe.height = '315';
                iframe.frameBorder = '0';
                chaptersContainer.appendChild(iframe);
            }
        });
    }

    function processWordHints(text) {
        return text.replace(/\[\[(.+?)\|(.+?)\]\]/g, (_, word, hint) => {
            return `<span class="word" data-hint="${hint}">${word}</span>`;
        });
    }

    // 页面加载完成后调用 loadChapterList
    document.addEventListener('DOMContentLoaded', loadChapterList);
</script>

    <script type="module" src="js/main.js"></script>
</body>
</html>